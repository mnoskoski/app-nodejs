name: Docker Build App
on:
  push:
    branches:
      - master

env:
  agentSO: ubuntu-latest
  NODE-VERSION: '14'
jobs:
  getValuesEnvironment:
    runs-on: ubuntu-latest
    steps:
      - name: HelloWorldWithDate
        run: echo "Hello World $(date)"
      - name: listDirectory
        run: ls -lah

  ScanSecurity:
    runs-on: ubuntu-latest
    needs: getValuesEnvironment
    steps:
      - uses: actions/checkout@v2
      - name: installDockerScan
        run: curl -L https://download.docker.com/linux/ubuntu/dists/hirsute/pool/stable/amd64/docker-scan-plugin_0.7.0~ubuntu-hirsute_amd64.deb -o docker-scan.deb      
      - name: installpackage
        run: sudo dpkg -i docker-scan.deb
      - name: export variable
        run: | 
          export DOCKER_SCAN_SUGGEST=false
          echo $DOCKER_SCAN_SUGGEST
      - name: docker-scan
        run: |
          docker scan --accept-license --version
      - name: ExecuteDockerScan
        run: docker scan -f Dockerfile docker-scan:e2e
      - name: testNpmAuditPackageJson
        run: |
          npm run audit
          npm run lint
        continue-on-error: true

  DockerBuildAndTest:
    runs-on: ubuntu-latest
    needs: ScanSecurity
    steps:
      - uses: actions/checkout@v2
      - name: DockerBuildImage
        run: docker build . -t mnoskoski/app-nodesjs
      - name: DockerRun
        run: docker run -it -d -p 8080:4000 mnoskoski/app-nodesjs
      - name: TestRunApp
        run: docker ps -a
      - name: DockerComposeUp
        run: docker-compose -f docker-compose.yaml up -d --build
      - name: testingExecution
        run: docker ps -a

  deploy-dev:
    runs-on: ubuntu-latest
    environment:
      name: dev
      url: 'http://mnoskoski.com'
    needs: DockerBuildAndTest
    steps:
      - name: DeployDev
        run: echo "deploy sucesso"
      
  deploy-hmg:
    runs-on: ubuntu-latest
    environment:
      name: hmg
      url: 'mnoskoski-hmg.com.br'
    needs: deploy-dev
    steps:
      - name: deployingHmg
        run: echo "deploy sucesso"

  deploy-prod:
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: 'mnoskoski-prod.com.br'
    needs: deploy-hmg
    steps:
      - name: deployingProd
        run: echo "deploy sucesso"